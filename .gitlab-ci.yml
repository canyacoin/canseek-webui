image: registry.gitlab.com/canya-com/node-build-container:1.2

variables:
  APP_PATH: /builds/$CI_PROJECT_PATH

before_script:
  - cd $APP_PATH
  - mkdir -p src/environments

stages:
  - build
  - deploy

build:staging:
  stage: build
  only:
    - develop
  artifacts:
    name: "$CI_JOB_NAME"
    paths:
      - $APP_PATH/dist
  script:
    - npm install
    - echo $ENVIRONMENT_STAGING >> $APP_PATH/src/environments/environment.dev.ts
    - ENV=dev npm run build && firebase use canseek-dev;

build:production:
  stage: build
  only:
    - master
  artifacts:
    name: "$CI_JOB_NAME"
    paths:
      - $APP_PATH/dist
  script:
    - npm install
    - echo $ENVIRONMENT_PROD >> $APP_PATH/src/environments/environment.prod.ts
    - ENV=prod npm run build && firebase use canseek-prod;

deploy:
  stage: deploy
  only:
    - develop
    - master
  dependencies:
    - build:staging
    - build:production
  script:
    - firebase deploy --token "$FIREBASE_TOKEN"
